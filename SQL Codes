# SQL Codes Used for Analysis

-- 1) Provide the list of markets in which customer "Atliq Exclusive" 
-- operates its business in the APAC region.

	SELECT distinct market, customer, region
	FROM dim_customer
	WHERE customer = 'Atliq Exclusive' AND region = 'APAC';

-- 2. What is the percentage of unique product increase in 2021 vs. 2020? The
-- final output contains these fields,
-- unique_products_2020
-- unique_products_2021
-- percentage_chg
	
	With product_count as
(
Select count(distinct Case when Fiscal_year=2020 then product_code end) as unique_products_2020,
		count(distinct Case when Fiscal_year=2021 then product_code end) as unique_products_2021
        From fact_sales_monthly
        )
select unique_products_2020,unique_products_2021, 
round(((unique_products_2020- unique_products_2021)*100)/unique_products_2020,2 )as percentage_CHANGE 
from product_count;

-- 3. Provide a report with all the unique product counts for each segment and sort them in descending order of product counts.
-- The final output contains 2 fields, segment product_count
SELECT segment, count(distinct product_code) as product_count
FROM dim_product
GROUP BY segment
ORDER BY product_count DESC
;

-- 4. Follow-up: Which segment had the most increase in unique products in 2021 vs 2020? 
-- The final output contains these fields, segment product_count_2020 product_count_2021 difference

with tot_products as
		(SELECT count( distinct fs.product_code) as total_products, fiscal_year , segment
		FROM fact_sales_monthly as fs
        LEFT JOIN dim_product 
        ON fs.product_code = dim_product.product_code
		GROUP BY fiscal_year, segment)
SELECT a.total_products as unique_products_2020,
		b.total_products as unique_products_2021, 
        b.total_products - a.total_products as difference,
        a.segment,
	ROUND((b.total_products-a.total_products) / a.total_products *100 , 2) as pct_change
	
FROM tot_products as a
LEFT JOIN tot_products as b
ON (a.fiscal_year+1 = b.fiscal_year and a.segment = b.segment)
WHERE b.total_products is not null
ORDER BY a.fiscal_year,pct_change DESC
;


-- 5. Products with highest and lowest manufacturing cost

SELECT 
	*
FROM 
	-- getting max value
	(select dp.product_code, fm.manufacturing_cost as manufacturing_cost_max_min, dp.product, segment
	FROM fact_manufacturing_cost as fm
    INNER JOIN dim_product as dp
    ON fm.product_code = dp.product_code
	where fm.manufacturing_cost = (SELECT MAX(manufacturing_cost) FROM fact_manufacturing_cost)) as table1

UNION ALL
	-- getting min value
	(select dp.product_code, fm.manufacturing_cost as manufacturing_cost_max_min, dp.product, segment
	FROM fact_manufacturing_cost as fm
	INNER JOIN dim_product as dp
	ON fm.product_code = dp.product_code
	where manufacturing_cost = (SELECT MIN(manufacturing_cost) FROM fact_manufacturing_cost)  )
;

-- 6. A report which contains top 5 customers who received an average high pre_invoice_discount_pct 
-- for the fiscal_year 2021 and in the Indian market

SELECT  dc.customer,
		dc.customer_code,
		ROUND(fp.pre_invoice_discount_pct * 100, 2)  as Avg_disc_pct 
    
FROM fact_pre_invoice_deductions as fp
INNER JOIN dim_customer as dc
ON fp.customer_code = dc.customer_code
WHERE fiscal_year = 2021 and market = "India"
GROUP BY dc.customer 
ORDER BY Avg_disc_pct DESC
LIMIT 5
;



-- 7. A complete report of Gross sales amount for the customer "Atliq Exclusive" for each month
-- This analysis helps to get an idea of low and high-performing months and take strategic decisions

SELECT 
		YEAR(date) as Year,
		MONTH(date) as month,
		sum(sold_quantity * gross_price) AS gross_sales_amount

FROM fact_sales_monthly as fs
INNER JOIN fact_gross_price as fp
ON fs.product_code = fp.product_code and fs.fiscal_year = fp.fiscal_year
INNER JOIN dim_customer as dc
ON fs.customer_code = dc.customer_code
WHERE customer = "Atliq Exclusive"
group by month, YEAR(date)
ORDER BY Year, month
;

-- 8. 2020 Quarter with maximum quantities sold

SELECT 
	CASE
		WHEN MONTH(date) BETWEEN 9 AND 11 THEN 'FIRST QUARTER'
        WHEN MONTH(date) BETWEEN 12 AND 2 THEN 'SECOND QUARTER'
        WHEN MONTH(date) BETWEEN 3 AND 5 THEN 'THIRD QUARTER'
        WHEN MONTH(date) BETWEEN 6 AND 8 THEN 'FOURTH QUARTER'
	END AS QUARTER ,
	date,
    CONCAT(CAST(ROUND(SUM(sold_quantity)/1000000, 2) AS CHAR), " M")   
    as total_quantities_sold
FROM fact_sales_monthly 
WHERE fiscal_year = 2020
GROUP BY QUARTER
ORDER BY total_quantities_sold DESC
;

-- 9. Channel with more gross sales in 2021 and percentage contributions

WITH channels as (SELECT 
						channel,
						(SUM(sold_quantity * gross_price) / 1000000) as gross_sales_mln
				FROM fact_sales_monthly as fm
				JOIN fact_gross_price as fp
				ON fm.product_code = fp.product_code
				JOIN dim_customer as dc
				ON fm.customer_code = dc.customer_code
				WHERE fm.fiscal_year = 2021
				GROUP BY channel
				ORDER BY gross_sales_mln DESC )

SELECT *,
		ROUND(gross_sales_mln * 100 / (SELECT SUM(gross_sales_mln) FROM channels) ,2) as pct_contributions
FROM channels
;


-- 10. Top 3 products  in each division that has high total_sold_quantity for fiscal year 2021

WITH ranked_product as (
			-- creating a table with total_sold_quantities and rank_order columns
			WITH top_product AS (SELECT  fm.product_code,
											product,
											division,
											SUM(sold_quantity) as total_sold_quantity
								FROM fact_sales_monthly as fm
								JOIN dim_product as dp 
								ON fm.product_code = dp.product_code
								WHERE fiscal_year =2021
								GROUP BY fm.product_code, division
								ORDER BY total_sold_quantity DESC)

			SELECT *,
					-- creating a rank column
					RANK () OVER ( PARTITION BY division
					ORDER BY total_sold_quantity DESC) as rank_order
			FROM top_product )

-- finally filtering the above created table to have 1,2 and 3 ranks
SELECT *
FROM ranked_product 
WHERE rank_order in (1,2,3)
;
